<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WSJ Article Analyzer</title>
  <style>
    body { font-family:-apple-system,system-ui; background:#0b0c10; color:#eee; margin:0; }
    .wrap { max-width:980px; margin:24px auto; padding:0 16px; }
    .card { background:#161821; border:1px solid #2a2d3a; border-radius:16px; padding:14px; margin-top:12px; }
    .muted { color:#aaa; font-size:12px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:820px){ .row{ grid-template-columns:1fr; } }
    input, textarea, button {
      width:100%; box-sizing:border-box;
      padding:10px 12px; border-radius:12px;
      border:1px solid #2a2d3a; background:#0f1118; color:#eee; outline:none;
    }
    textarea { min-height:220px; resize:vertical; }
    button { cursor:pointer; font-weight:650; margin-top:8px; background:#1f2230; }
    pre { white-space:pre-wrap; word-wrap:break-word; margin:0; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btnrow button { width:auto; }
    .ok { color:#8ef0a6; }
    .err { color:#ffb4b4; }
    code { background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0">WSJ Article Analyzer</h2>
    <div class="muted">Generate prompt → run in model → paste JSON once → Save to log.</div>

    <div class="card">
      <div class="row">
        <div>
          <div class="muted">URL</div>
          <input id="url" placeholder="https://www.wsj.com/..." />
        </div>
        <div>
          <div class="muted">Headline</div>
          <input id="title" placeholder="Headline…" />
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Article text (paste from WSJ)</div>
        <textarea id="article" placeholder="Paste the article body or key excerpts here…"></textarea>
      </div>

      <div class="btnrow">
        <button onclick="generate()">Generate prompt</button>
        <button onclick="copyPrompt()">Copy prompt</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Tip: Make the model return TWO outputs; copy only the JSON (first output) into the box below.
      </div>
    </div>

    <div class="card">
      <div class="muted">Prompt (paste into ChatGPT / Claude)</div>
      <pre id="out"></pre>
    </div>

    <div class="card">
      <div class="muted">Model JSON output (paste ONLY the JSON object here)</div>
      <textarea id="jsonOut" placeholder='{"title":"...","source":"WSJ", ...}'></textarea>

      <div class="btnrow">
        <button onclick="saveToLog()">Save to log</button>
        <button onclick="clearJson()">Clear JSON</button>
      </div>

      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
function qs(k){ return new URLSearchParams(window.location.search).get(k) || ""; }

document.getElementById("url").value = qs("u");
document.getElementById("title").value = qs("t");

let ACTIVE_THEMES = {"active_themes":[]};

async function loadThemes(){
  try {
    const r = await fetch("/themes");
    if (r.ok) ACTIVE_THEMES = await r.json();
  } catch(e) {}
}
loadThemes();

function generate(){
  const url = document.getElementById("url").value.trim();
  const title = document.getElementById("title").value.trim();
  const article = document.getElementById("article").value;

  const schema = `{
  "title": "",
  "source": "WSJ",
  "published_at": "",
  "category": "Structural | Cyclical | Policy/Regulatory | Earnings | Geopolitics | Markets | Narrative/Opinion | Noise",
  "signal_strength": "High | Medium | Low",
  "time_horizon": "Immediate | Medium | Structural",
  "signal_bullets": ["", ""],
  "mechanism": "",
  "base_case": "",
  "tail_risk": "",
  "action": "Act | Prepare/Monitor | No Action",
  "action_triggers": ["", ""],
  "confidence": 1,
  "tags": [],
  "reinforces": [],
  "contradicts": [],
  "updates_confidence": ""
}`;

  const prompt = `
SYSTEM:
You are an analyst. Return TWO outputs in this exact order:
(1) One JSON object that strictly matches the schema below.
(2) A six-section narrative write-up.

Schema:
${schema}

Rules:
- High signal if any of: new policy with enforcement/timeline; earnings results/guidance; physical constraints; financing conditions shifting.
- Low signal if: "stocks rose/fell" with no new catalyst; optics/personality story; opinion without new facts.
- Action = Act only if mechanism is direct AND horizon is immediate/medium AND you can name 1–3 concrete triggers. Otherwise Prepare/Monitor or No Action.
- Spell out acronyms on first use, then include the acronym in parentheses.
- Be conservative.

Six-section format (exact headings):
1️⃣ What actually matters in this article (distilled)
2️⃣ The critical mechanism (this is the insight)
3️⃣ This connects directly to your other themes
4️⃣ Why this matters for inflation (non-obvious but important)
5️⃣ Does this change the “action” stance?
6️⃣ Your clean log entry for #2 (ready to save)

USER:
URL: ${url}
Headline: ${title}

Active themes:
${JSON.stringify(ACTIVE_THEMES, null, 2)}

Article text:
"""${article}"""
`.trim();

  document.getElementById("out").textContent = prompt;
}

async function copyPrompt(){
  const txt = document.getElementById("out").textContent || "";
  if (!txt) return;
  await navigator.clipboard.writeText(txt);
  setStatus("Prompt copied.", "ok");
}

function clearJson(){
  document.getElementById("jsonOut").value = "";
  setStatus("", "");
}

function setStatus(msg, kind){
  const el = document.getElementById("status");
  el.className = "muted " + (kind || "");
  el.textContent = msg || "";
}

async function saveToLog(){
  const raw = document.getElementById("jsonOut").value.trim();
  if (!raw){
    setStatus("Paste the JSON object first.", "err");
    return;
  }

  let obj;
  try {
    obj = JSON.parse(raw);
  } catch(e){
    setStatus("Invalid JSON. Make sure you pasted ONLY the JSON object.", "err");
    return;
  }

  if (!obj.published_at) obj.published_at = new Date().toISOString();
  if (!obj.source) obj.source = "WSJ";
  obj.url = document.getElementById("url").value.trim() || obj.url;
  obj.title = document.getElementById("title").value.trim() || obj.title;
  obj.created_at = new Date().toISOString();

  try{
    const r = await fetch("/save", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(obj)
    });
    const data = await r.json().catch(()=> ({}));
    if (r.ok && data.ok){
      setStatus("Saved to analysis_log.jsonl ✅", "ok");
    } else {
      setStatus("Save failed: " + (data.error || ("HTTP " + r.status)), "err");
    }
  } catch(e){
    setStatus("Save failed: could not reach local server. Is server.py running?", "err");
  }
}
</script>
</body>
</html>
