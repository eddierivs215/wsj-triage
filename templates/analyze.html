<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WSJ Article Analyzer</title>
  <style>
    body { font-family:-apple-system,system-ui; background:#0b0c10; color:#eee; margin:0; }
    .wrap { max-width:980px; margin:24px auto; padding:0 16px; }
    .card { background:#161821; border:1px solid #2a2d3a; border-radius:16px; padding:14px; margin-top:12px; }
    .muted { color:#aaa; font-size:12px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:820px){ .row{ grid-template-columns:1fr; } }
    input, textarea, button {
      width:100%; box-sizing:border-box;
      padding:10px 12px; border-radius:12px;
      border:1px solid #2a2d3a; background:#0f1118; color:#eee; outline:none;
    }
    textarea { min-height:220px; resize:vertical; }
    button { cursor:pointer; font-weight:600; margin-top:8px; background:#1f2230; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .btn-primary { background:#2563eb; border-color:#3b74ed; color:#fff; }
    .btn-primary:hover:not(:disabled) { background:#1d4ed8; }
    pre { white-space:pre-wrap; word-wrap:break-word; margin:0; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btnrow button { width:auto; }
    .ok { color:#8ef0a6; }
    .err { color:#ffb4b4; }
    code { background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
    .narrative { font-size:13px; line-height:1.65; white-space:pre-wrap; color:#ddd; padding-top:4px; }
    .section-label { font-size:11px; font-weight:700; text-transform:uppercase;
      letter-spacing:.06em; color:#6b7fa3; margin-bottom:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0">WSJ Article Analyzer</h2>
    <div class="muted" style="margin-top:4px">Paste article → Analyze with AI → review → Save to log.</div>

    <!-- ── Input card ───────────────────────────────────────────── -->
    <div class="card">
      <div class="row">
        <div>
          <div class="muted">URL</div>
          <input id="url" placeholder="https://www.wsj.com/…" />
        </div>
        <div>
          <div class="muted">Headline</div>
          <input id="title" placeholder="Headline…" />
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Article text</div>
        <textarea id="article" placeholder="Paste the article body here…&#10;&#10;(Tip: if you copied the article before opening this page, it may auto-fill below.)"></textarea>
      </div>

      <div class="btnrow">
        <button class="btn-primary" id="aiBtn" onclick="analyzeWithAI()">Analyze with AI</button>
        <button id="genBtn" onclick="togglePrompt()">Generate prompt</button>
        <button id="copyBtn" onclick="copyPrompt()" style="display:none">Copy prompt</button>
      </div>

      <div id="clipMsg" class="muted" style="margin-top:6px; display:none"></div>
    </div>

    <!-- ── Prompt card (hidden; manual fallback) ────────────────── -->
    <div class="card" id="promptCard" style="display:none">
      <div class="section-label">Prompt — paste into ChatGPT / Claude</div>
      <pre id="out"></pre>
    </div>

    <!-- ── Narrative card (hidden; shown after AI analysis) ─────── -->
    <div class="card" id="narrativeCard" style="display:none">
      <div class="section-label">Narrative analysis</div>
      <div id="narrativeOut" class="narrative"></div>
    </div>

    <!-- ── JSON save card ───────────────────────────────────────── -->
    <div class="card">
      <div class="section-label">JSON output — auto-filled by "Analyze with AI", or paste manually</div>
      <textarea id="jsonOut" style="min-height:160px; font-family:monospace; font-size:12px;"
        placeholder='{"title":"…","source":"WSJ", …}'></textarea>

      <div class="btnrow">
        <button onclick="saveToLog()">Save to log</button>
        <button onclick="clearJson()">Clear JSON</button>
      </div>

      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
function qs(k){ return new URLSearchParams(window.location.search).get(k) || ""; }

document.getElementById("url").value   = qs("u");
document.getElementById("title").value = qs("t");

let ACTIVE_THEMES = {"active_themes":[]};

async function loadThemes(){
  try {
    const r = await fetch("/themes");
    if (r.ok) ACTIVE_THEMES = await r.json();
  } catch(e) {}
}
loadThemes();

// ── Clipboard auto-fill ──────────────────────────────────────────────────────
async function tryClipboardFill(){
  const articleEl = document.getElementById("article");
  if (articleEl.value.trim()) return;  // already has content from URL params or user
  try {
    const text = await navigator.clipboard.readText();
    if (text && text.trim().length > 100) {
      articleEl.value = text.trim();
      showClipMsg("Article auto-filled from clipboard.");
    }
  } catch(e) {
    // Permission denied or API unavailable — silent fail
  }
}
// Attempt after a brief delay so the browser considers the page "interactive"
setTimeout(tryClipboardFill, 300);

function showClipMsg(msg){
  const el = document.getElementById("clipMsg");
  el.textContent = msg;
  el.style.display = "";
  setTimeout(() => { el.style.display = "none"; }, 4000);
}

// ── AI analysis ──────────────────────────────────────────────────────────────
async function analyzeWithAI(){
  const url     = document.getElementById("url").value.trim();
  const title   = document.getElementById("title").value.trim();
  const article = document.getElementById("article").value.trim();

  if (!article){
    setStatus("Paste the article text first.", "err");
    return;
  }

  const btn = document.getElementById("aiBtn");
  btn.disabled = true;
  btn.textContent = "Analyzing…";
  setStatus("Calling Claude API…", "");

  // Hide stale narrative while loading
  document.getElementById("narrativeCard").style.display = "none";

  try {
    const r = await fetch("/api/analyze", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ url, title, article, themes: ACTIVE_THEMES })
    });
    const data = await r.json().catch(() => ({}));
    if (r.ok && data.ok) {
      document.getElementById("jsonOut").value = JSON.stringify(data.analysis, null, 2);
      if (data.narrative) {
        document.getElementById("narrativeOut").textContent = data.narrative;
        document.getElementById("narrativeCard").style.display = "";
      }
      setStatus("Analysis complete — review JSON below, then Save.", "ok");
    } else {
      setStatus("Analysis failed: " + (data.error || ("HTTP " + r.status)), "err");
    }
  } catch(e) {
    setStatus("Analysis failed: could not reach local server.", "err");
  } finally {
    btn.disabled = false;
    btn.textContent = "Analyze with AI";
  }
}

// ── Manual prompt fallback ───────────────────────────────────────────────────
let promptVisible = false;

function togglePrompt(){
  if (!promptVisible) {
    generate();
    document.getElementById("promptCard").style.display = "";
    document.getElementById("copyBtn").style.display = "";
    document.getElementById("genBtn").textContent = "Regenerate prompt";
    promptVisible = true;
  } else {
    generate(); // regenerate in place
  }
}

function generate(){
  const url     = document.getElementById("url").value.trim();
  const title   = document.getElementById("title").value.trim();
  const article = document.getElementById("article").value;

  const schema = `{
  "title": "",
  "source": "WSJ",
  "published_at": "",
  "category": "Structural | Cyclical | Policy/Regulatory | Earnings | Geopolitics | Markets | Narrative/Opinion | Noise",
  "signal_strength": "High | Medium | Low",
  "time_horizon": "Immediate | Near-term | Structural",
  "signal_bullets": ["", ""],
  "mechanism": "",
  "base_case": "",
  "tail_risk": "",
  "action": "Act | Prepare/Monitor | No Action",
  "action_triggers": ["", ""],
  "confidence": 1,
  "tags": [],
  "reinforces": [],
  "contradicts": [],
  "updates_confidence": ""
}`;

  const prompt = `You are an analyst. Return TWO outputs in this exact order:
(1) One JSON object that strictly matches the schema below.
(2) A six-section narrative write-up.

Schema:
${schema}

Rules:
- High signal if any of: new policy with enforcement/timeline; earnings results/guidance; physical constraints; financing conditions shifting.
- Low signal if: "stocks rose/fell" with no new catalyst; optics/personality story; opinion without new facts.
- Action = Act only if mechanism is direct AND horizon is immediate/medium AND you can name 1-3 concrete triggers. Otherwise Prepare/Monitor or No Action.
- Spell out acronyms on first use, then include the acronym in parentheses.
- Be conservative.

Six-section format (exact headings):
1. What actually matters in this article (distilled)
2. The critical mechanism (this is the insight)
3. This connects directly to your other themes
4. Why this matters for inflation (non-obvious but important)
5. Does this change the action stance?
6. Your clean log entry (ready to save)

URL: ${url}
Headline: ${title}

Active themes:
${JSON.stringify(ACTIVE_THEMES, null, 2)}

Article text:
"""${article}"""`.trim();

  document.getElementById("out").textContent = prompt;
}

async function copyPrompt(){
  const txt = document.getElementById("out").textContent || "";
  if (!txt) return;
  await navigator.clipboard.writeText(txt);
  setStatus("Prompt copied.", "ok");
}

// ── Save ─────────────────────────────────────────────────────────────────────
function clearJson(){
  document.getElementById("jsonOut").value = "";
  document.getElementById("narrativeCard").style.display = "none";
  setStatus("", "");
}

function setStatus(msg, kind){
  const el = document.getElementById("status");
  el.className = "muted " + (kind || "");
  el.textContent = msg || "";
}

async function saveToLog(){
  const raw = document.getElementById("jsonOut").value.trim();
  if (!raw){
    setStatus("Paste (or generate) the JSON object first.", "err");
    return;
  }

  let obj;
  try {
    obj = JSON.parse(raw);
  } catch(e){
    setStatus("Invalid JSON — make sure you pasted only the JSON object.", "err");
    return;
  }

  if (!obj.published_at) obj.published_at = new Date().toISOString();
  if (!obj.source) obj.source = "WSJ";
  obj.url       = document.getElementById("url").value.trim() || obj.url;
  obj.title     = document.getElementById("title").value.trim() || obj.title;
  obj.created_at = new Date().toISOString();

  try {
    const r = await fetch("/save", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(obj)
    });
    const data = await r.json().catch(() => ({}));
    if (r.ok && data.ok){
      setStatus("Saved to analysis_log.jsonl ✓", "ok");
    } else {
      setStatus("Save failed: " + (data.error || ("HTTP " + r.status)), "err");
    }
  } catch(e) {
    setStatus("Save failed: could not reach local server. Is server.py running?", "err");
  }
}
</script>
</body>
</html>
